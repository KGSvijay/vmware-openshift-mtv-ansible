# roles/your_role_name/tasks/main.yml
---
- name: Gather VM datastore information from vCenter
  gather_facts: no
  vars:
    vm_name: "{{ vm_name }}"               # Name of the VM to fetch details for

  tasks:
    - name: Authenticate to vCenter and gather all datastore information
      vmware.vmware_rest.vcenter_datastore_info:
        hostname: "{{ vcenter_host }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        validate_certs: false
      register: datastore_info

    - name: Find datastores for the specific VM
      set_fact:
        vm_datastores: >-
          {{
            datastore_info.datastore_info
            | selectattr('vm', 'defined')
            | selectattr('vm', 'contains', vm_name)
            | map(attribute='name')
            | list
          }}

    - name: Display datastore information
      debug:
        msg: "VM '{{ vm_name }}' is using the following datastores: {{ vm_datastores | join(', ') }}"
